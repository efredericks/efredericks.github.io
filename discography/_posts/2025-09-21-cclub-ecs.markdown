---
layout: post
title: Computing Club Tutorial - Entity Component System (ECS)
description: tutorial on ECS in p5js
# image: assets/img/z-is-for-zero.png
# responsiveImage:
#   - src: assets/img/300.png
#     size: 300
#   - src: assets/img/600.png
#     size: 600
#   - src: assets/img/z-is-for-zero.png
#     size: 900
type: blog
# play:
#     - name: YouTube
#       url: https://www.youtube.com/
#     - name: SoundCloud
#       url: https://soundcloud.com/
# buy:
#   - url: https://backfromvoid.bandcamp.com/track/if-i-want-you-to
#     name: BandCamp
# embed_player:
#   type: bandcamp
#   src: track=2250182265/size=large/bgcol=ffffff/linkcol=0687f5/tracklist=false/artwork=small/transparent=true/
carousels:
  - images: # random
    - image: /assets/img/GenerativeGI/random/img-6.png
    - image: /assets/img/GenerativeGI/random/img-22.png
    - image: /assets/img/GenerativeGI/random/img-46.png
    - image: /assets/img/GenerativeGI/random/img-62.png
    - image: /assets/img/GenerativeGI/random/img-64.png
    - image: /assets/img/GenerativeGI/random/img-67.png
    - image: /assets/img/GenerativeGI/random/img-71.png
    - image: /assets/img/GenerativeGI/random/img-94.png
    - image: /assets/img/GenerativeGI/random/img-94-1.png
    - image: /assets/img/GenerativeGI/random/img-98.png
  - images: # single no clear
    - image: /assets/img/GenerativeGI/no-clear-single/img-10047.png
    - image: /assets/img/GenerativeGI/no-clear-single/img-10050.png
    - image: /assets/img/GenerativeGI/no-clear-single/img-10051.png
    - image: /assets/img/GenerativeGI/no-clear-single/img-10057.png
    - image: /assets/img/GenerativeGI/no-clear-single/img-10063.png
    - image: /assets/img/GenerativeGI/no-clear-single/img-10066.png
    - image: /assets/img/GenerativeGI/no-clear-single/img-10080.png
    - image: /assets/img/GenerativeGI/no-clear-single/img-10095.png
    - image: /assets/img/GenerativeGI/no-clear-single/img-10097.png
    - image: /assets/img/GenerativeGI/no-clear-single/img-10099.png
  - images: # single clear
    - image: /assets/img/GenerativeGI/clear-single/img-10045.png
    - image: /assets/img/GenerativeGI/clear-single/img-10048.png
    - image: /assets/img/GenerativeGI/clear-single/img-10059.png
    - image: /assets/img/GenerativeGI/clear-single/img-10059-1.png
    - image: /assets/img/GenerativeGI/clear-single/img-10068.png
    - image: /assets/img/GenerativeGI/clear-single/img-10074.png
    - image: /assets/img/GenerativeGI/clear-single/img-10076.png
    - image: /assets/img/GenerativeGI/clear-single/img-10087.png
    - image: /assets/img/GenerativeGI/clear-single/img-10087-1.png
    - image: /assets/img/GenerativeGI/clear-single/img-10093.png
  - images:  # lexicase no clear
    - image: /assets/img/GenerativeGI/no-clear-lexicase/img-10019.png
    - image: /assets/img/GenerativeGI/no-clear-lexicase/img-10058.png
    - image: /assets/img/GenerativeGI/no-clear-lexicase/img-10062.png
    - image: /assets/img/GenerativeGI/no-clear-lexicase/img-10068.png
    - image: /assets/img/GenerativeGI/no-clear-lexicase/img-10078.png
    - image: /assets/img/GenerativeGI/no-clear-lexicase/img-10084.png
    - image: /assets/img/GenerativeGI/no-clear-lexicase/img-10088.png
    - image: /assets/img/GenerativeGI/no-clear-lexicase/img-10090.png
    - image: /assets/img/GenerativeGI/no-clear-lexicase/img-10092.png
    - image: /assets/img/GenerativeGI/no-clear-lexicase/img-10099.png
  - images:  # lexicase clear
    - image: /assets/img/GenerativeGI/clear-lexicase/img-10056.png
    - image: /assets/img/GenerativeGI/clear-lexicase/img-10073.png
    - image: /assets/img/GenerativeGI/clear-lexicase/img-10085.png
    - image: /assets/img/GenerativeGI/clear-lexicase/img-10088.png
    - image: /assets/img/GenerativeGI/clear-lexicase/img-10092.png
    - image: /assets/img/GenerativeGI/clear-lexicase/img-10095.png
    - image: /assets/img/GenerativeGI/clear-lexicase/img-10096-1.png
    - image: /assets/img/GenerativeGI/clear-lexicase/img-10096.png
    - image: /assets/img/GenerativeGI/clear-lexicase/img-10099-1.png
    - image: /assets/img/GenerativeGI/clear-lexicase/img-10099.png
---

<hr size="1" />

- [functioning p5js sketch](tbd)

<hr size="1" />

# Tutorial overview

We're going to be creating a 2D, tile-based game using p5js.  

## What is ECS?

The Entity-Component-System (ECS) design pattern is a lovely pattern for managing a lot of disparate types of things in your game.  Specifically, you might want to define characters that move, characters that don't move, items, items that hurt you, items that talk to you, NPCs, enemies of varying type, etc.

The nice thing is that those all typically derive from the same base class.  They all need a position and a sprite, for example.  Essentially, we'll define an `Entity` class and inherit from that for all our varying types.

We may also want to give them different abilities/characteristics.  Enter *components* -- the tl;dr is that you will "equip" an entity with a certain component, and that entity will then check its list of components for its abilities.

This is a fairly reductive take on ECS and you can read about it in-depth on [Wikipedia](https://en.wikipedia.org/wiki/Entity_component_system) and [dev.to](https://dev.to/kspeakman/entity-component-system-an-old-new-thing-3224) and [this blog](https://www.richardlord.net/blog/ecs/why-use-an-entity-framework.html).

## A note on resources

Until you're ready to hire an artist, use royalty/copyright-free resources.  There are a **lot** available online, from [itch.io](https://itch.io/search?q=assets) to [opengameart](https://opengameart.org/) to (my favorite) [kenney.nl](https://kenney.nl).

Whatever you do though:

1. Avoid using copyrighted images (unless if you paid for it)
2. Include the license **every time** you use a resource, and check the attribution requirements for the original file
3. Avoid using AI-generated artwork - hire an artist

## Setup

1. Create an account on the p5js editor: [https://editor.p5js.org](p5js online editor)
2. Grab a spritesheet from [kenney.nl](https://kenney.nl): I'll be using the [microrogue resource](https://kenney.nl/assets/micro-roguelike). Make sure you include the License when you upload!
  * Double-note - we're using the "packed" sprite sheet, not individual images!  Both have pros and cons, however uploading hundreds of images to the online editor doesn't work very well.

  <!-- {% include carousel.html height="50" unit="%" duration="15" number="1" %} -->

## First steps

Ok, here we go!  Everything we'll be doing is in the online p5js editor, however you can export it to any website you want after we're done.

### 1. **Create a new project (directory structure)**

Let's start by defining a directory structure.  By default you'll have some p5 libraries, an `index.html`, and a `sketch.js`. 

If you aren't familiar:

* Any time we add a new `js` file we need to link to it within the `index.html` file - **before** we include the `sketch.js` file.  HTML/JavaScript is (typically) rendered **in-order**, so dependencies must be specified in the correct order.
* p5js uses a few functions to set things up:
  * `setup` runs before the `draw` cycle (or, the forever loop).  Set variable states and do all of your setup in this function.  With p5js 2.0 and beyond, all file loading happens in `setup` as well!
  * `draw` is your forever loop - it runs either as fast as possible or at a specified frame rate.

### 2. **Upload your asset files and create empty files**

Create a directory on the side called assets and upload your spritesheet **and** its license file.  While you're working there, create files named `components.js` and `entities.js` at the root of your directory (we could add sub-folders for organization, but for this we'll just keep it on the same level).

![uploading](/assets/img/ecs-js/uploading.png)

Note - if you want to upload to a folder then you need to hover over it and click the little dropdown triangle to the side, otherwise you upload to the root of the structure.

![uploading to folder](/assets/img/ecs-js/uploading2.png)

### 3. **Wire everything up**

In your `index.html` file, add the following lines *above* the call to include `sketch.js`:

```
<script src="components.js"></script>
<script src="entities.js"></script>
<script src="sketch.js"></script>
```

We need to put them above as they need to be parsed before `sketch.js` is parsed (for instance, any global variables we might want to share).

> Note that we are setting up a structure that is good for a quick demo - it would be much better to refactor our code to say, have a `Game` class controlling everything, ingesting the assets, managing entities, etc.  However, we're going to just use a few global variables to get things working.

### 4. **Use p5js 2.0.x**

Let's start you off with the latest version of p5js - click the version number (next to the gear icon) in the top right and select the latest 2.0.x version - I'm on 2.0.5.  This introduces a plethora of new features - the ones I'm most familiar with are that assets are now loaded in via `async`/`await` calls (instead of using a `preload` function).  Let's try it out:

At the top of your `sketch.js` file (in global space), add a variable:

```
let spritesheet;

...

function setup() {
  ...
```

And then modify your `setup` and `draw` functions to look like this:

```
async function setup() {
  // load in sprite sheet - change the filename to match your file
  await loadImage("assets/spritesheet.png"); 
  createCanvas(400, 400);
}

function draw() {
  background(0);
  image(spritesheet, 0, 0);
}
```

You should now see your spritesheet being drawn to the top left corner!  Note that we also draw the background to give the illusion of animation (once things start to move).  If you didn't redraw the background then things would smear the screen.

![spritesheet](/assets/img/ecs-js/spritesheet-draw.png)

### 5. **Draw your character to the screen**

Last but not least, we need to direct the canvas to be optimized for pixel art.  If you look at the p5js documentation there are `smooth()` and `noSmooth()` functions, however they don't see to have the desired effect (note: I don't know why).

After your call to `createCanvas(400, 400)` add the following:

```
async function setup() {
  // load in sprite sheet - change the filename to match your file
  await loadImage("assets/spritesheet.png"); 
  createCanvas(400, 400);

  drawingContext.imageSmoothingEnabled = false;
}
```

The image should be a bit crisper now, though if you have the 'small' tileset you won't notice.

### 6. **Move them around**

## Entities (step 2)

create a base entity class with empty functions (use vector instead of x,y)
create a moveable entity class
show update/draw
create a player and enemy class
create the array and add the player and enemies
create dvd and follower

## Components (step 3)

remove custom entities for AI and replace with components

## Handling a map (manually)

generate a map

## Camera follow

.. tbd

## Final steps?

Performance optimization - record and see waht's going on

## Next steps

This is a taste of what you can do.  A few things:

* p5js is canonically *slow* for JavaScript games as it makes some choices in terms of rendering performance.  It is for teaching and not necessarily production games.  Manually draw to the `canvas` with straight JavaScript or use a framework like [PhaserJS](https://phaser.io) to optimize your game.
  * Check the Performance tab in your browser to profile!  Also, [p5 optimization suggestions](https://github.com/processing/p5.js/wiki/Optimizing-p5.js-Code-for-Performance#identifying-slow-code-profiling)

* Add gameplay!  We've essentially created a 2D walking simulator.

* Wire in Tiled maps!  I've not tried it, but a lot of 2D games use the [Tiled Editor](https://www.mapeditor.org/) for setting up maps, obstacles, etc. [p5.tiledmap](https://github.com/linux-man/p5.tiledmap)

* Check out the other [p5js libraries](https://p5js.org/libraries/)! There are a **ton** of things you can do with it!
  * There is an [ECS library](https://github.com/RandomGamingDev/BasicECSJs/) as well that I've never tried, but it also includes a Scene Manager, which is nice (alternatively, just use a state machine to manage that yourself).

* Make a roguelike game in Godot!  The [SelinaDev tutorial](https://selinadev.github.io/) is a nice introduction to Godot (and more imporantly for this, ECS).


camera + sprites
https://editor.p5js.org/efredericks/sketches/wErqg4bAf