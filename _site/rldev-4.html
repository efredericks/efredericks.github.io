<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/assets/styles/styles.css">
<link rel="stylesheet" href="https://indestructibletype.com/fonts/Jost.css" type="text/css" charset="utf-8" />
<script src="https://kit.fontawesome.com/79c31398dc.js" crossorigin="anonymous"></script>

<!-- favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon-16x16.png">
<link rel="manifest" href="/assets/img/site.webmanifest">
<link rel="mask-icon" href="/assets/img/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/img/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- feed -->
<link type="application/atom+xml" rel="alternate" href="https://efredericks.github.io/feed.xml" title="erik fredericks" />




<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>fredericks does the roguelikedev tutorial - 4 | erik fredericks</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="fredericks does the roguelikedev tutorial - 4" />
<meta name="author" content="efredericks" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="chat, procgen, cleanup" />
<meta property="og:description" content="chat, procgen, cleanup" />
<meta property="twitter:description" content="chat, procgen, cleanup" />
<link rel="canonical" href="https://efredericks.github.io/rldev-4.html" />
<meta property="og:url" content="https://efredericks.github.io/rldev-4.html" />
<meta property="og:site_name" content="erik fredericks" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-07-21T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="fredericks does the roguelikedev tutorial - 4" />
<meta name="twitter:site" content="@efredericks" />
<meta name="twitter:creator" content="@efredericks" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"efredericks"},"dateModified":"2023-07-21T00:00:00-04:00","datePublished":"2023-07-21T00:00:00-04:00","description":"chat, procgen, cleanup","headline":"fredericks does the roguelikedev tutorial - 4","mainEntityOfPage":{"@type":"WebPage","@id":"https://efredericks.github.io/rldev-4.html"},"url":"https://efredericks.github.io/rldev-4.html"}</script>
<!-- End Jekyll SEO tag -->


  </head>
  <body>
    <aside class="menu">
    <div class="menu-top">
        <div class="menu-top_logo">
            <a href="/" >
                <img src="/assets/img/Fredericks-Small.jpg" alt="Logo" onerror="this.style.display='none'">
            </a>
        </div>
        <div class="menu-top_expand" onclick="toggleExpander(this)">
            <div class="bar_top"></div>
            <div class="bar_middle"></div>
            <div class="bar_bottom"></div>
        </div>
        <ul class="navigation">
            
            <li>
                <a href="/" category="home" title=""
                
                >
                    <span>home</span>
                </a>
            </li>
            
            <li>
                <a href="/students.html" category="students" title="students tooltip"
                
                >
                    <span>students</span>
                </a>
            </li>
            
            <li>
                <a href="/teaching.html" category="teaching" title="teaching tooltip"
                
                >
                    <span>teaching</span>
                </a>
            </li>
            
            <li>
                <a href="/publications.html" category="publications" title="publications tooltip"
                
                >
                    <span>publications</span>
                </a>
            </li>
            
            <li>
                <a href="/activities.html" category="activities" title="activities tooltip"
                
                >
                    <span>activities</span>
                </a>
            </li>
            
            <li>
                <a href="/posts/" category="" title=""
                
                    class="selected"
                
                >
                    <span>posts</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="menu-contact">
        

        <a href="https://github.com/efredericks" target="_blank">
            <i class="fa fa-github"></i>
        </a>
        

        <a href="https://scholar.google.com/citations?user=wpdiGa0AAAAJ" target="_blank">
            <i class="fa fa-toilet-paper"></i>
        </a>
        

        <a href="https://youtube.com/@erikfredericks" target="_blank">
            <i class="fa fa-youtube-play"></i>
        </a>
        

        <a href="https://twitch.tv/mrdoktorprofessor" target="_blank">
            <i class="fa fa-twitch"></i>
        </a>
        

        <a href="https://twitter.com/erik_fredericks" target="_blank">
            <i class="fab fa-twitter"></i>
        </a>
        

        <a href="mailto:frederer@gvsu.edu" target="">
            <i class="fas fa-envelope"></i>
        </a>
        
    </div>
</aside>

      <main class="content-layout">
          <div class="post">
    <div class="content-container ">

        <header>
            <h1>fredericks does the roguelikedev tutorial - 4</h1>
            
        </header>
        <div class="post-content">
            <hr size="1" />

<ul>
  <li>
    <p><a href="https://www.reddit.com/r/roguelikedev/comments/159b1yu/roguelikedev_does_the_complete_roguelike_tutorial/jteeuhl/" target="_blank">Week 4 post</a></p>
  </li>
  <li>
    <p><a href="https://github.com/efredericks/RL-MMO" target="_blank">Project repo</a></p>
  </li>
</ul>

<hr size="1" />

<p>This week I spent some time getting a limited chat up and running, along with basic procgen for the map and some extra hooks for HP.  All the screenshots will have the new procgen in there, but I’m going to talk about chat first.</p>

<p>Before starting though, I am pleased to report that this does work in a public environment.  I put the repo on a Google Cloud virtual machine (microinstance) and played it with a friend for a bit.  No lag from either end at this point, though 2 people isn’t really a stress test.  It was more of a “does it actually work outside of my own machine” type of test.</p>

<p>And that, at least, passed just fine.</p>

<div align="center">
  <img src="https://i.imgur.com/LF2TnIl.png" title="yay" alt="yay" />
</div>

<hr />

<h2 id="chat">Chat</h2>

<p>I wanted players to have a limited chat so that they can talk to each other.  Otherwise we lose a bit of the MMO-ness.  In taking a page from RotMG, I thought little speech bubbles would be a good idea.</p>

<div align="center">
  <img src="https://i.imgur.com/dVeW4gc.png" alt="rotmg chat" title="rotmg chat" />
</div>

<p>We’ll get there eventually, but each person only says one thing at a time - there is no buffer.  What I did was to give each <code class="language-plaintext highlighter-rouge">MoveableEntity</code> a chat object - currently a list but that may get pared down a single object.  The list is forced into a mutable tuple - element 0 is the chat message and element 1 is the timer.</p>

<p>The timer will decrement for each game tick that a chat message exists on an entity, allowing me to map opacity to time remaining.  In its current state things decrement quickly, but are visible and <em>functional</em> at least.</p>

<p>The nice bit here is that all <code class="language-plaintext highlighter-rouge">MoveableEntity</code> objects get a chat, so enemies can now talk to you as well!  This will eventually extend to NPCs once they get added.</p>

<p>The screenshot is a bit hard to see below, but the enemies will randomly select a bit of angry flavor text when they’re following you.  The rat is saying ‘!!’ at the moment.</p>

<div align="center">
  <img src="https://i.imgur.com/6hwUJQn.png" alt="rat chat" title="rat chat" />
</div>

<p>Colors and interface are by no means final and currently quite difficult to read, but I figured prettifying it would take a back seat to actual implementation.  Plus then I’d need to add things like text wrapping and all those fun calculations and my eyes glazed over a bit.</p>

<p>Work for future me.</p>

<hr />

<h2 id="procgen">Procgen</h2>

<p>Ok, now for procedural generation.</p>

<p><em>Deep breath</em></p>

<p>I didn’t use <code class="language-plaintext highlighter-rouge">tcod</code>.  I apologize to all.  I just … didn’t feel like rewriting all of my code to handle the <code class="language-plaintext highlighter-rouge">numpy</code> arrays.  In the future that would be a better idea for performance, however for now we’ll just stick with a 2D list.</p>

<p>Otherwise, this proof of concept will never be done.</p>

<p>Anywho, I used the <code class="language-plaintext highlighter-rouge">opensimplex</code> noise library (<a href="https://pypi.org/project/opensimplex/" target="_blank">PyPi reference</a>) and simply mapped ranges to tile values.  As you can see below the level is fairly water-heavy.  I’ll be tweaking this significantly as I go, but I honestly like how it looks at the moment.</p>

<p>Pretty simple mapping that is fun to play with for a ‘standard’ Simplex noise look:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>n = opensimplex.noise2(c*zoom, r*zoom)
newtile = "empty"
if n &lt; -0.8 or n &gt; 0.8:     # water2 is not walkable
    newtile = "water2"
elif n &lt; -0.6 or n &gt; 0.6:
    newtile = "water1"
elif n &lt; -0.4 or n &gt; 0.4:
    newtile = "floor2"
elif n &lt; -0.2 or n &gt; 0.2:
    newtile = "floor1"
_map[z][r].append(newtile)
</code></pre></div></div>

<div align="center">
  <b>Floor 1</b><br />
  <img src="https://i.imgur.com/AQV8rp1.png" alt="procgen 1" title="procgen 1" />
</div>

<p>Plus, as you descend in Z-levels the zoom changes as well.  This comes care of a handy utility function I always transpose from p5js:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># map function similar to p5.js
def p5map(n, start1, stop1, start2, stop2): 
    return ((n - start1) / (stop1 - start1)) * (stop2 - start2) + start2
</code></pre></div></div>

<p>–</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># map generation loop
for z in range(self.NUM_LEVELS):
    zoom = p5map(z, 0, self.NUM_LEVELS, 0.1, 0.001)
    ...
</code></pre></div></div>

<div align="center">
  <b>Floor 3</b><br />
  <img src="https://i.imgur.com/QTz0oiZ.png" alt="procgen 2" title="procgen 2" />
</div>

<p>Gives a nice feeling of depth and the environments varying.</p>

<hr />

<h2 id="other">Other</h2>

<p>I also updated the drops/items a bit so that players could eat apples, rather than just collect them.  To make this happen, a new ‘use’ key got added (right now that only eats apples) and heals the player (and plays the associated pickup sound since I didn’t feel like sound hunting at the moment).  To heal the player a new <code class="language-plaintext highlighter-rouge">updateHP</code> function got added to <code class="language-plaintext highlighter-rouge">MoveableEntity</code> that will be the basis of HP management and death.  If <code class="language-plaintext highlighter-rouge">HP</code> &lt; 0, then the function will return <code class="language-plaintext highlighter-rouge">false</code>, otherwise it will cap at the entity’s <code class="language-plaintext highlighter-rouge">maxHP</code> attribute.  No HP overloading planned as of this point.</p>

<p>However, testing this functionality was not really possible as nobody can hurt you.  So, all players got started with 2 HP for a bit just to make sure that all the socket communication was happy.</p>

<p>Test test test!</p>

<p>…then test again.</p>

<p>–</p>

<p>One other bit I added was some sprite management.  Each tile now has a named key, an associated glyph, and a color value (including alpha).  This is all done in hex code on the client-side (I’m making the assumption all game logic happens server-side and all drawing/rendering/UI/sounds happens client-side):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// spritesheet
let SPRITESHEET = {
    // env
    wall1: { sprite: '#', color: '#ccc' },
    wall2: { sprite: '#', color: '#999' },
    floor1: { sprite: '.', color: '#333' },
    floor2: { sprite: '.', color: '#666' },
    water1: { sprite: '~', color: '#008080' },
    water2: { sprite: '~', color: '#0011ee' },
    empty: { sprite: ' ', color: '#000' },
    stairsDown: { sprite: '&gt;', color: '#00ffff' },
    stairsUp: { sprite: '&lt;', color: '#00ffff' },
    ...
}
</code></pre></div></div>

<p>To me, going this route is nicely extensible as I can also tack on sprite images as well if I’d like, or offsets into a spritesheet.  Previously it was all <code class="language-plaintext highlighter-rouge">if</code> checks in code for the exact sprite, so not very programmer-friendly.</p>

<hr />

<p>Next week I plan to work on enemy AI a bit, since right now everything either wanders or follows you.  Also, I’d like to start dipping into accessibility a bit to ensure that the game itself is playable for all.  I don’t have a whole lot of experience in managing that with a canvas, so some additional research is going to be needed.</p>

<p>Here’s a GIF of current playing through a few levels and testing out chatting.  Even though I didn’t need any, I just couldn’t stop myself from picking up some apples.</p>

<div align="center">
  <img src="https://i.imgur.com/ZHLAHK8.gif" alt="playthrough" title="playthrough" />
</div>

<hr />

<p><a href="/rldev-3.html">Last post</a></p>

<p><a href="/rldev-5.html">Next post</a></p>

        </div>
        <div class="post-metadata">
            <p class="discography-album_release-date">
    date: 21 July 2023
</p>


<p class="discography-album_type">
    post type: blog
</p>
















        </div>
    </div>
</div>

          <script>
    window.addEventListener("load", () => {
        document.getElementsByClassName("copyrights")[0].innerHTML =
            `Copyrights &copy; ${new Date().getFullYear()} erik fredericks | template c/o <a href='https://github.com/ItsPatrq/minimal-music-project' target='_blank'>minimal-music-project</a>`;
    });
</script>
<footer>
    <p class="copyrights">
    </p>
</footer>
      </main>
      
    <script>
      (function () {
    window.toggleExpander = function toggleExpander(x) {
        const menu = document.getElementsByClassName("menu")[0];
        const navigation = document.getElementsByClassName("navigation")[0];
        if (menu.classList.contains('expanded--visible')) {
            menu.classList.toggle('expanded--visible');
            navigation.addEventListener('transitionend', function(e) {
                menu.classList.toggle("expanded");
              }, {
                capture: false,
                once: true,
                passive: false
              });
        } else {
            menu.classList.toggle("expanded");
            setTimeout(() => menu.classList.toggle('expanded--visible'), 20);
        }
    };
    window.addEventListener("load", () => {
        // #region click to enlarge images 
        const imageWrappers = document.querySelectorAll(".click-to-enlarge");
        imageWrappers.forEach(imageWrapper => {
            
            imageWrapper.addEventListener("click", () => {
                const img = imageWrapper.getElementsByTagName("img")[0];
                const src = img.attributes.getNamedItem("src");
                const modal = document.createElement("div");
                const removeModal = function() {
                    modal.classList.add("hidden");
                    setTimeout(() => {
                        document.body.removeChild(modal);
                    }, 200);
                };
                const newImage = document.createElement("img");
                newImage.classList.add("modal__picture-zoomed--image");
                newImage.setAttribute("src", src.value);
                modal.classList.add("modal__picture-zoomed", "hidden");
                // modal.style.backgroundImage = `URL("${src.value}")`;
                modal.addEventListener("click", removeModal);
                modal.append(newImage);
                document.body.append(modal);
                document.body.addEventListener("keyup", e => {
                    if (e.key === 'Escape') {
                        removeModal();
                    }
                }, {once : true});
                setTimeout(() => {
                    modal.classList.remove("hidden");
                }, 0);
            });
            
        });
        // #endregion click to enlarge images 
        // #region embedded audio players
        const players = document.querySelectorAll("iframe.embedded-player");
        const getParamsByPlayerType = (src, type) => {
            const rt = (src, height) => ({
                src: src,
                height: height
            });
            switch (type.toLocaleLowerCase()) {
                case "soundcloud":
                    return rt(`https://w.soundcloud.com/player/?url=${src}`, 125);
                case "bandcamp":
                    return rt(`https://bandcamp.com/EmbeddedPlayer/${src}`, 125);
                case "spotify":
                    return rt(`https://open.spotify.com/embed/track/${src}`, 80);
                case "spotifyalbum":
                    return rt(`https://open.spotify.com/embed/album/${src}`, 80);
                case "spotifyplaylist":
                    return rt(`https://open.spotify.com/embed/playlist/${src}`, 80);
                case "spotifyepisode":
                    return rt(`https://open.spotify.com/embed/episode/${src}`, 152);
                case "spotifyshow":
                    return rt(`https://open.spotify.com/embed/show/${src}`, 152);
                case "youtube":
                    return rt(`https://www.youtube.com/embed/${src}`, 350);
                case "anchor.fm":
                    return rt(`https://anchor.fm/sucias/embed/episodes/${src}`,102);
                default:
                    return rt(src, 125);
            }
        };
        players.forEach(player => {
            const givenSrc = player.getAttribute("givenSrc");
            const type = player.getAttribute("type");
            const { src, height } = getParamsByPlayerType(givenSrc, type);
            player.setAttribute("src", src);
            player.setAttribute("height", height);
            player.classList.remove("hidden");
        });
        // #endregion embedded audio players
    });
})();
    </script>
    


  </body>
</html>