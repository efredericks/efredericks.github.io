<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/assets/styles/styles.css">
<link rel="stylesheet" href="https://indestructibletype.com/fonts/Jost.css" type="text/css" charset="utf-8" />
<script src="https://kit.fontawesome.com/79c31398dc.js" crossorigin="anonymous"></script>

<!-- favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon-16x16.png">
<link rel="manifest" href="/assets/img/site.webmanifest">
<link rel="mask-icon" href="/assets/img/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/img/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- feed -->
<link type="application/atom+xml" rel="alternate" href="https://efredericks.github.io/feed.xml" title="erik fredericks" />




<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>fredericks does the roguelikedev tutorial - 3 | erik fredericks</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="fredericks does the roguelikedev tutorial - 3" />
<meta name="author" content="efredericks" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Z-levels, UI refinement, camera, sounds, drops" />
<meta property="og:description" content="Z-levels, UI refinement, camera, sounds, drops" />
<meta property="twitter:description" content="Z-levels, UI refinement, camera, sounds, drops" />
<link rel="canonical" href="https://efredericks.github.io/rldev-3.html" />
<meta property="og:url" content="https://efredericks.github.io/rldev-3.html" />
<meta property="og:site_name" content="erik fredericks" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-07-14T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="fredericks does the roguelikedev tutorial - 3" />
<meta name="twitter:site" content="@efredericks" />
<meta name="twitter:creator" content="@efredericks" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"efredericks"},"dateModified":"2023-07-14T00:00:00-04:00","datePublished":"2023-07-14T00:00:00-04:00","description":"Z-levels, UI refinement, camera, sounds, drops","headline":"fredericks does the roguelikedev tutorial - 3","mainEntityOfPage":{"@type":"WebPage","@id":"https://efredericks.github.io/rldev-3.html"},"url":"https://efredericks.github.io/rldev-3.html"}</script>
<!-- End Jekyll SEO tag -->


  </head>
  <body>
    <aside class="menu">
    <div class="menu-top">
        <div class="menu-top_logo">
            <a href="/" >
                <img src="/assets/img/Fredericks-Small.jpg" alt="Logo" onerror="this.style.display='none'">
            </a>
        </div>
        <div class="menu-top_expand" onclick="toggleExpander(this)">
            <div class="bar_top"></div>
            <div class="bar_middle"></div>
            <div class="bar_bottom"></div>
        </div>
        <ul class="navigation">
            
            <li>
                <a href="/" category="home" title=""
                
                >
                    <span>home</span>
                </a>
            </li>
            
            <li>
                <a href="/students.html" category="students" title="students tooltip"
                
                >
                    <span>students</span>
                </a>
            </li>
            
            <li>
                <a href="/teaching.html" category="teaching" title="teaching tooltip"
                
                >
                    <span>teaching</span>
                </a>
            </li>
            
            <li>
                <a href="/publications.html" category="publications" title="publications tooltip"
                
                >
                    <span>publications</span>
                </a>
            </li>
            
            <li>
                <a href="/activities.html" category="activities" title="activities tooltip"
                
                >
                    <span>activities</span>
                </a>
            </li>
            
            <li>
                <a href="/posts/" category="" title=""
                
                    class="selected"
                
                >
                    <span>posts</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="menu-contact">
        

        <a href="https://github.com/efredericks" target="_blank">
            <i class="fa fa-github"></i>
        </a>
        

        <a href="https://scholar.google.com/citations?user=wpdiGa0AAAAJ" target="_blank">
            <i class="fa fa-toilet-paper"></i>
        </a>
        

        <a href="https://youtube.com/@erikfredericks" target="_blank">
            <i class="fa fa-youtube-play"></i>
        </a>
        

        <a href="https://twitch.tv/mrdoktorprofessor" target="_blank">
            <i class="fa fa-twitch"></i>
        </a>
        

        <a href="https://twitter.com/erik_fredericks" target="_blank">
            <i class="fab fa-twitter"></i>
        </a>
        

        <a href="mailto:frederer@gvsu.edu" target="">
            <i class="fas fa-envelope"></i>
        </a>
        
    </div>
</aside>

      <main class="content-layout">
          <div class="post">
    <div class="content-container ">

        <header>
            <h1>fredericks does the roguelikedev tutorial - 3</h1>
            
        </header>
        <div class="post-content">
            <hr size="1" />

<ul>
  <li>
    <p><a href="https://www.reddit.com/r/roguelikedev/comments/152ns71/roguelikedev_does_the_complete_roguelike_tutorial/jsez1go/" target="_blank">Week 3 post</a></p>
  </li>
  <li>
    <p><a href="https://github.com/efredericks/RL-MMO" target="_blank">Project repo</a></p>
  </li>
</ul>

<hr size="1" />

<p>This week was all about refinement and starting to prep things for procedural generation.  Also, this post is probably going to be fairly terse as there were a lot of little updates and I have some other deadlines not related to this.</p>

<p>Here we go!</p>

<hr />

<p>First of all we have a bit of a user interface refinement.  First we have some relevant stats being reported in the game window sidebar (<code class="language-plaintext highlighter-rouge">console.log</code> was getting annoying), some animated CSS background trickery to spice things up, and a new font, <a href="https://fonts.google.com/specimen/Chivo+Mono" target="_blank">Chivo Mono, c/o Google</a>.</p>

<p>For the animated background I just gave my main window a pair of drop shadows and animated their blurriness and placement.  Nothing too crazy, but hits that vaporwave aesthetic that is oh so pleasing.</p>

<p><img src="https://i.imgur.com/W2Cz22N.png" alt="Screenshot" /></p>

<p>Here is the relevant code if you’re interested (we’ll talk about that little checkbox in a bit):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#game-canvas {
    background: #222;
    margin: 0 auto;
    display: block;
    width: 900px;
    /* 640 + 260 */
    height: 480px;
    position: absolute;
    left: 50%;
    top: 50%;

    margin-top: -240px;
    margin-left: -455px;
    /* 900/2 + 10/2 */

    border: 5px solid #eee;
    border-radius: 20px;
    padding: 10px;

    animation: moveShadow ease-in-out 15s infinite;
}

@keyframes moveShadow {
    0% {
        box-shadow: -15px -15px 45px 0 rgba(220, 0, 220, 0.25), 15px 15px 45px 0 rgba(0, 229, 255, 0.25);
    }

    50% {
        box-shadow: 15px -15px 145px 0 rgba(220, 0, 220, 0.25), -15px 15px 145px 0 rgba(0, 229, 255, 0.25);
    }

    100% {
        box-shadow: -15px -15px 45px 0 rgba(220, 0, 220, 0.25), 15px 15px 45px 0 rgba(0, 229, 255, 0.25);
    }
}

</code></pre></div></div>

<p>This is also a good reminder (to myself) that I need to download the font locally, as I was doing some testing in a place without WiFi and defaulting to <code class="language-plaintext highlighter-rouge">monospace</code> wasn’t nearly as nice to look at (for me).</p>

<p>We also have a series of dots in the background that are fudged via some <code class="language-plaintext highlighter-rouge">linear-gradient</code> calls and are the result of me googling “animated CSS background.”  The only thing I changed here is the background color and the original was here: <a href="https://codepen.io/edmundojr/pen/xOYJGw" target="_blank">https://codepen.io/edmundojr/pen/xOYJGw</a>.</p>

<hr />

<p>Next up we have … Z-levels! I mean dungeon depth.  Everything so far has been mainly proof of concept, adding the ability for the dungeon to have floors starts to make it a bit more real.</p>

<p>If you’ve never done this before, it is pretty straightforward. The game map gets a new dimension, that’s about it.  This also means that all references to the map now need to check that dimension as well.</p>

<p>Instead of  <code class="language-plaintext highlighter-rouge">gameMap[r][c]</code> we have <code class="language-plaintext highlighter-rouge">gameMap[z][r][c]</code>.</p>

<p>And the <code class="language-plaintext highlighter-rouge">pos</code> attribute for all <code class="language-plaintext highlighter-rouge">Entity</code> objects get a new <code class="language-plaintext highlighter-rouge">level</code> attribute so we know on which floor they live.</p>

<p>Upon adding this I spent some time quashing bugs, notably one where you could kill enemies on other floors because I forgot to update my attack mechanism (so, if you were on floor 1 and the enemy was on floor 3, as long as you were checking the row/column you could still hit them…).</p>

<p>Another thing I added was stairs, though right now the player’s placement is a bit random upon entering and leaving them - work for future me.</p>

<hr />

<p>After this I wanted to add a bit more non-tutorial bits to it, so we have some sounds!  I took a note out of the <a href="https://nluqo.github.io/broughlike-tutorial/stage7.html" target="_blank">Broughlike tutorial</a> for managing them and found a nice <a href="https://filmcow.itch.io/filmcow-sfx" target="_blank">royalty free sound pack by the group that did Charlie the Unicorn</a>.</p>

<p>Now we have ambient sounds, sound effects upon all sorts of things, and whatnot.  Right now they’re mainly placeholders and absolutely zero sound normalization has been done, but I like it!</p>

<p>The fun bit here is that the pack has a large number of “similar” sounds, so I included them all and provided a bit of randomness for when an event pops.  For instance, there is a group of <code class="language-plaintext highlighter-rouge">bat hit 1</code> through <code class="language-plaintext highlighter-rouge">bat hit 15</code> sounds that are played if the player hits a monster.</p>

<p>For this I added a new global lookup table for each of my sound events with the event name and how many sounds are available.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// pick a random index for each sound on [1,len]
let soundMaps = {
    monHit: 2,
    playerHit: 15,
    pickup: 4,
    stairs: 7,
    spawn: 1,
};
</code></pre></div></div>

<p>So if a player hits a monster, I just grab a random number on [1,14] and tack that onto my sound player (<code class="language-plaintext highlighter-rouge">snd</code> is the event name and <code class="language-plaintext highlighter-rouge">sounds</code> hold the loaded audio files and are keyed on the name of the event):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>playSound('playerHit');

// abstracted a bit
playSound = (snd) =&gt; {
    let idx = getRandomInt(1, soundMaps[snd] + 1);
    let key = `${snd}${idx}`;
    sounds[key].currentTime = 0;
    sounds[key].play();
}
</code></pre></div></div>

<p>I also bulk-converted all the <code class="language-plaintext highlighter-rouge">wav</code> files to <code class="language-plaintext highlighter-rouge">ogg</code> in the thought that it would be better for file size.  I did 0 checks to make sure this was the case.</p>

<hr />

<p>Two more things, camera and drops!  First lets talk drops.  I updated my <code class="language-plaintext highlighter-rouge">Entity</code> system a bit to include the type(s) of items that can be dropped as well as how many. Right now all we have are apples so that’s all that can be dropped.  However this is setup in a nice little global loot table that I can balance later.</p>

<p>This table lists out all the relevant information for each <em>thing</em> in the game.  A better way would be to sub-class out every single entity (as the Broughlike/TCOD tutorials do), but I wanted everything in one concise place.</p>

<p>Note: this is <strong>terrible</strong> for human error - everything is keyed on something typed out multiple times.  Just keep piling on the technical debt to get to that minimum viable product.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LOOKUP_STATS = {
    'maxHP': {
        'player': 10,
        'gobbo': 2,
        'snek': 2,
        'rat': 1,
    },
    'sprite': {
        # moveables
        'player': '@',
        'gobbo': 'g',
        'snek': 's',
        'rat': 'r',

        # static
        'apple': 'a',
    },
    # name: list[(tuple(type, max, chance))] - random() &gt; chance
    'drops': {
        'rat': [('apple', 1, 0.25)],
        'gobbo': [('apple', 3, 0.35)],
        'snek': [('apple', 5, 0.5)],
    }
}
</code></pre></div></div>

<blockquote>
  <p>I probably should also create better enemies at some point because writing these out reminds me that I have the sense of humor of a toddler.</p>
</blockquote>

<p>That’s not terribly exciting though and is really just object/state management.  What is fun is scrolling cameras!</p>

<p><img src="https://i.imgur.com/TrwjCX1.gif" alt="Scrolling camera" /></p>

<p>This is always the bane of my existence because I always do this kind of thing by hand (note: Unity/Godot make this ridiculously easy).  However, I’ve done it enough times now that I can cheat by looking at old code and just transplant it.</p>

<p>The basis is here: <a href="https://www.roguebasin.com/index.php/Scrolling_map" target="_blank">https://www.roguebasin.com/index.php/Scrolling_map</a></p>

<p>Essentially, we create a viewport around the player and only draw things within that viewport.  Note - this is lovely for performance optimization as you only need to manage visuals for things in view.  You do still need to update AI and whatnot for things off screen, but at least we don’t have to draw it all.</p>

<p>The scrolling camera and larger map are what will be the requirement for my procedural generation as I like large worlds, however keeping it constrained for this use case will be a fun challenge.</p>

<hr />

<p>Last but not least, I started working on the README file so that I could remember how to do things in the future when I invariably run out of time.  The semester start is a month away and that means that it is nigh time for class prep to begin.  How to add enemies and items, etc.</p>

<hr />

<p>Next week I’m planning on adding proper procedural generation, so hoping to either make use of the <code class="language-plaintext highlighter-rouge">tcod</code> library for that or <code class="language-plaintext highlighter-rouge">opensimplex</code>.  Perhaps some drunken walking for caves, we shall see.</p>

<p>Also a slew of bugs/issues to fix, including player placement from stairs.</p>

<hr />

<p><a href="/rldev-2.html">Last post</a></p>

<p><a href="/rldev-4.html">Next post</a></p>

        </div>
        <div class="post-metadata">
            <p class="discography-album_release-date">
    date: 14 July 2023
</p>


<p class="discography-album_type">
    post type: blog
</p>
















        </div>
    </div>
</div>

          <script>
    window.addEventListener("load", () => {
        document.getElementsByClassName("copyrights")[0].innerHTML =
            `Copyrights &copy; ${new Date().getFullYear()} erik fredericks | template c/o <a href='https://github.com/ItsPatrq/minimal-music-project' target='_blank'>minimal-music-project</a>`;
    });
</script>
<footer>
    <p class="copyrights">
    </p>
</footer>
      </main>
      
    <script>
      (function () {
    window.toggleExpander = function toggleExpander(x) {
        const menu = document.getElementsByClassName("menu")[0];
        const navigation = document.getElementsByClassName("navigation")[0];
        if (menu.classList.contains('expanded--visible')) {
            menu.classList.toggle('expanded--visible');
            navigation.addEventListener('transitionend', function(e) {
                menu.classList.toggle("expanded");
              }, {
                capture: false,
                once: true,
                passive: false
              });
        } else {
            menu.classList.toggle("expanded");
            setTimeout(() => menu.classList.toggle('expanded--visible'), 20);
        }
    };
    window.addEventListener("load", () => {
        // #region click to enlarge images 
        const imageWrappers = document.querySelectorAll(".click-to-enlarge");
        imageWrappers.forEach(imageWrapper => {
            
            imageWrapper.addEventListener("click", () => {
                const img = imageWrapper.getElementsByTagName("img")[0];
                const src = img.attributes.getNamedItem("src");
                const modal = document.createElement("div");
                const removeModal = function() {
                    modal.classList.add("hidden");
                    setTimeout(() => {
                        document.body.removeChild(modal);
                    }, 200);
                };
                const newImage = document.createElement("img");
                newImage.classList.add("modal__picture-zoomed--image");
                newImage.setAttribute("src", src.value);
                modal.classList.add("modal__picture-zoomed", "hidden");
                // modal.style.backgroundImage = `URL("${src.value}")`;
                modal.addEventListener("click", removeModal);
                modal.append(newImage);
                document.body.append(modal);
                document.body.addEventListener("keyup", e => {
                    if (e.key === 'Escape') {
                        removeModal();
                    }
                }, {once : true});
                setTimeout(() => {
                    modal.classList.remove("hidden");
                }, 0);
            });
            
        });
        // #endregion click to enlarge images 
        // #region embedded audio players
        const players = document.querySelectorAll("iframe.embedded-player");
        const getParamsByPlayerType = (src, type) => {
            const rt = (src, height) => ({
                src: src,
                height: height
            });
            switch (type.toLocaleLowerCase()) {
                case "soundcloud":
                    return rt(`https://w.soundcloud.com/player/?url=${src}`, 125);
                case "bandcamp":
                    return rt(`https://bandcamp.com/EmbeddedPlayer/${src}`, 125);
                case "spotify":
                    return rt(`https://open.spotify.com/embed/track/${src}`, 80);
                case "spotifyalbum":
                    return rt(`https://open.spotify.com/embed/album/${src}`, 80);
                case "spotifyplaylist":
                    return rt(`https://open.spotify.com/embed/playlist/${src}`, 80);
                case "spotifyepisode":
                    return rt(`https://open.spotify.com/embed/episode/${src}`, 152);
                case "spotifyshow":
                    return rt(`https://open.spotify.com/embed/show/${src}`, 152);
                case "youtube":
                    return rt(`https://www.youtube.com/embed/${src}`, 350);
                case "anchor.fm":
                    return rt(`https://anchor.fm/sucias/embed/episodes/${src}`,102);
                default:
                    return rt(src, 125);
            }
        };
        players.forEach(player => {
            const givenSrc = player.getAttribute("givenSrc");
            const type = player.getAttribute("type");
            const { src, height } = getParamsByPlayerType(givenSrc, type);
            player.setAttribute("src", src);
            player.setAttribute("height", height);
            player.classList.remove("hidden");
        });
        // #endregion embedded audio players
    });
})();
    </script>
    


  </body>
</html>